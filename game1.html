<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journey start</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            background-color: #e0f2fe; /* Lighter blue background */
            color: #0c4a6e; /* Darker blue text */
            padding: 1rem;
            box-sizing: border-box;
        }
        .game-wrapper {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 720px;
            text-align: center;
        }
        #gameArea {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 1.5rem auto;
            border: 2px solid #bae6fd; /* Light blue border */
            border-radius: 0.5rem;
            overflow: hidden; /* Important to contain absolutely positioned hotspots */
        }
        #gameImage { /* This is the main scene background image */
            display: block;
            width: 100%;
            height: auto;
            border-radius: 0.375rem;
            transition: opacity 0.5s ease-in-out;
        }
        .hotspot { /* This class now applies to <img> OR <div> elements used as hotspots */
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, filter 0.2s ease-in-out, background-color 0.2s;
	    border-radius: 0.375rem;
	    border: 1px dashed rgba(255,255,255,0.3);
            /* The following properties apply to both <img> and <div> hotspots */
        }
        .hotspot:hover {
            transform: scale(1.05); 
            /* For IMG hotspots */
            filter: brightness(1.1); 
            /* For DIV hotspots (invisible becomes slightly visible) */
            background-color: rgba(0, 255, 0, 0.15);
        }
        .message-area {
            min-height: 80px;
            background-color: #f0f9ff;
            border: 1px solid #e0f2fe;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: left;
            white-space: pre-wrap;
            color: #075985;
        }
        .inventory-area {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background-color: #f0f9ff;
            border: 1px solid #e0f2fe;
            border-radius: 0.5rem;
        }
        .inventory-area h3 {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #0369a1;
        }
        .inventory-list {
            list-style: disc;
            padding-left: 1.5rem;
            text-align: left;
        }
        .inventory-list li {
            color: #0ea5e9;
        }
        .restart-button {
            background-color: #f43f5e;
            color: white;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            margin-top: 1rem;
        }
        .restart-button:hover {
            background-color: #e11d48;
        }
        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #082f49;
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <h1>The castle</h1>
        
        <div id="gameArea">
            <img id="gameImage" src="https://placehold.co/600x600/A8D8B4/333333?text=Loading+Castle..." alt="Castle Scene">
            <!-- Hotspot elements will be dynamically added here by JavaScript -->
        </div>

        <div id="messageArea" class="message-area">
            Loading game...
        </div>

        <div id="inventoryArea" class="inventory-area">
            <h3>Inventory:</h3>
            <ul id="inventoryList" class="inventory-list">
                <li>(Empty)</li>
            </ul>
        </div>
        
        <button id="restartButton" class="restart-button" style="display: none;">Restart Game</button>
    </div>

    <script>
        // DOM Elements
        const gameArea = document.getElementById('gameArea');
        const gameImage = document.getElementById('gameImage'); // Main background scene image
        const messageArea = document.getElementById('messageArea');
        const inventoryList = document.getElementById('inventoryList');
        const restartButton = document.getElementById('restartButton');

        // Game State
        let gameState = {};

        // --- Scene Definitions ---
        // IMPORTANT: Replace ALL 'https://placehold.co/...' image URLs with your actual, working image paths/URLs.
        // To make a hotspot invisible (transparent div), simply OMIT the `imageUrl` property or set it to null/undefined.
        const gameScenes = {
            "Gate": {
                imageUrl: "https://ai.oldwisebear.com/Game1/Gate.jpg",
                message: "You stand in front of the castle gate finally, however there is noone outside... why?.",
                hotspots: [
                    { 
                        id: "gate_rubble", 
                        style: { left: "75%", top: "65%", width: "20%", height: "25%" }, 
                        objectId: "inspect_rubble" 
                    },
                    { 
                        id: "gate_entrance", 
                        style: { left: "20%", top: "60%", width: "15%", height: "25%" }, 
                        objectId: "gate_entrance" 
                    }
                ]
            },
            "City": {
                imageUrl: "https://ai.oldwisebear.com/Game1/background_image.jpg",
                message: "You come into a city and notice it was burned down not that long ago. She has to be somewhere here...",
                hotspots: [
                    { id: "house", 
			   style: { left: "30%", top: "55%", width: "25%", height: "15%" }, 
			   objectId: "enter_house" },
                    { id: "Cultist_leader", 
                           imageUrl: "https://ai.oldwisebear.com/Game1/Cultist_horse.png", 
			   style: { left: "35%", top: "40%", width: "10%", height: "10%" }, 
			   objectId: "talk_to_cultist_leader" },
                    { id: "Cultist1", 
                           imageUrl: "https://ai.oldwisebear.com/Game1/Cultist2.png", 
			   style: { left: "70%", top: "40%", width: "10%", height: "10%" }, 
			   objectId: "talk_to_cultist" },
                    { id: "Cultist2", 
                           imageUrl: "https://ai.oldwisebear.com/Game1/Cultist2.png", 
			   style: { left: "55%", top: "80%", width: "10%", height: "10%" }, 
			   objectId: "talk_to_cultist" },
                    { id: "gate_exit", 
			   style: { left: "10%", top: "80%", width: "15%", height: "15%" }, 
		           objectId: "gate_exit" },
		    { id: "fire_rubble", 
                           imageUrl: "https://ai.oldwisebear.com/Game1/Wooden_ruble.png", 
			   style: { left: "5%", top: "50%", width: "10%", height: "10%" }, 
			   objectId: "inspect_fire_rubble" }
                ]
            },
            "House": {
                imageUrl: "https://ai.oldwisebear.com/Game1/inside_building.jpg",
                message: "The building is still a burning a bit, however you see someone left a chest inside.",
                hotspots: [
                    { 
                        id: "chest", 
                        imageUrl: "https://ai.oldwisebear.com/Game1/chest.png", 
                        style: { left: "65%", top: "80%", width: "20%", height: "15%" }, 
                        objectId: "inspect_chest" 
                    },
                    { 
                        id: "rake", 
                        imageUrl: "https://ai.oldwisebear.com/Game1/rake.png", 
                        style: { left: "25%", top: "35%", width: "5%", height: "10%" }, 
                        objectId: "inspect_rake" 
                    },
                    { 
                        id: "house_exit", 
                        style: { left: "50%", top: "70%", width: "10%", height: "20%" }, 
                        objectId: "exit_house" 
                    }
                ]
            },
            "Storage": {
                imageUrl: "https://ai.oldwisebear.com/Game1/Storage.jpg",
                message: "You walk down the ladder to a weird small storage room... what for was it used?.",
                hotspots: [
                    { 
                        id: "city_trapdoor", 
                        style: { left: "40%", top: "10%", width: "20%", height: "20%" }, 
                        objectId: "exit_storage" 
                    },
                    { 
                        id: "ring_hole", 
                        imageUrl: "https://ai.oldwisebear.com/Game1/ring_hole.png", 
                        style: { left: "80%", top: "60%", width: "10%", height: "10%" }, 
                        objectId: "inspect_ring_hole" 
                    },
                    { 
                        id: "chest_key", 
                        imageUrl: "https://ai.oldwisebear.com/Game1/chest_key.png", 
                        style: { left: "20%", top: "80%", width: "10%", height: "5%" }, 
                        objectId: "pick_upchest_chest_key" 
                    }
                ]
            },
            "Bad_end": {
                imageUrl: "https://ai.oldwisebear.com/Game1/bad_end1.jpg",
                message: "You died.",
                hotspots: [
                    { 
                        id: "end", 
                        style: { left: "75%", top: "65%", width: "20%", height: "25%" }, 
                        objectId: "end" 
                    }
                ]
            },
            "Bad_end2": {
                imageUrl: "https://ai.oldwisebear.com/Game1/bad_end2.jpg",
                message: "You joined to cult, your story will continue as a mindless slave.",
                hotspots: [
                    { 
                        id: "end", 
                        style: { left: "75%", top: "65%", width: "20%", height: "25%" }, 
                        objectId: "end" 
                    }
                ]
            },
            "END": {
                imageUrl: "https://ai.oldwisebear.com/Game1/Castle_END.jpg",
                message: "...",
                hotspots: [
                    { 
                        id: "end", 
                        style: { left: "75%", top: "65%", width: "20%", height: "25%" }, 
                        objectId: "end" 
                    }
                ]
            }
        };

        // --- Interactive Object Definitions ---
        const interactiveObjects = {
            "gate_entrance": {
                handler: () => {
                    changeScene("City");
                    gameState.message = "You enter the city slowly, not knowing what's inside.";
                }
            },
            "enter_house": {
                handler: () => {
                    changeScene("House");
                    gameState.message = "You enter the house, hoping it won't collapse at you.";
                }
            },
            "exit_house": {
                handler: () => {
                    changeScene("City");
                    gameState.message = "You come back to the city as quietly as possible.";
                }
            },
            "exit_storage": {
                handler: () => {
                    changeScene("City");
                    gameState.message = "You come back to the city as quietly as possible.";
                }
            },
            "gate_exit": { 
                handler: () => {
                    changeScene("Gate");
                    gameState.message = "You are back in front of the gate.";
                }
            },
            "inspect_ring_hole": { 
                handler: () => {
                    if (checkInventory("Ring")) {
                        changeScene("END");
                        gameState.message = "You insert the ring and hear a loud clang. Suddenly the wall slides open in front of you, you go through a long tunnel at which end you see a burning castle. \n\nCongratulations! You've passed the cultist!\n\nThanks for playing!";
                        removeItemFromInventory("Ring");		
                        const existingHotspots = gameArea.querySelectorAll('.hotspot'); 
                        existingHotspots.forEach(hs => hs.remove());
                        restartButton.style.display = 'inline-block';
                    } else {
                        gameState.message = "There a werid ring shaped hole in the wall, I wonder where does it go.";
                    }
                }
            },
            "inspect_rubble": { 
                 handler: () => {
                    if (!gameState.flags.stoneCollected) {
                        gameState.message = "You look through the rubble, but find nothing but stones. You decide to take one.";
                        addItemToInventory("Stone");
                        gameState.flags.stoneCollected = true;
                    } else {
                        gameState.message = "You've already looked through this. There is nothing else interesting here.";
                    }
                }
            },
            "inspect_fire_rubble": { 
                handler: () => {
                    if (checkInventory("Rake")) { 
                        gameState.message = "You use the rake to search through the smoldering rubble.";
                        removeItemFromInventory("Rake");
                    	changeScene("Storage");
 			gameState.flags.trapdoor_unlocked = true;
                    } else if (gameState.flags.trapdoor_unlocked) { 
                            gameState.message = "You enter the trapdoor again.";
			    changeScene("Storage");
                    } else {
                        gameState.message = "Burning rubble, there might be something hidden in it...";
                    }
                }
            },
            "inspect_chest": {
                handler: () => {
                    if (checkInventory("Chest Key")) { 
                        gameState.message = "You use the Chest Key and the chest creaks open. You find a shiny ring... whos it might be.";
                        removeItemFromInventory("Chest Key");
	                addItemToInventory("Ring")
 			gameState.flags.chestOpened = true;
                    } else if (gameState.flags.chestOpened) { 
                            gameState.message = "The chest is empty.";		
                    } else {
                        gameState.message = "The chest is closed shut. You need a key.";
                    }
                }
            },
            "inspect_rake": {
                handler: () => {
                    if (checkInventory("Stone")) { 
                        gameState.message = "You throw the stone feeling lucky and you actually are, the rake fall to the ground and you pick it up.";
	                addItemToInventory("Rake")
                        removeItemFromInventory("Stone");
 			gameState.flags.rakeObtained = true;
                    }  else {
                        gameState.message = "The rake is too far up to reach.";
                    }
                }
            },
            "pick_upchest_chest_key": {
                handler: () => {
                    if (!gameState.flags.keyObtained) { 
                        gameState.message = "You look at the ground and find a key laying around.";
	                addItemToInventory("Chest Key")
 			gameState.flags.keyObtained = true;
                    }  else {
                        gameState.message = "The key is just laying there.";
                    }
                }
            },
            "talk_to_cultist": {
                handler: () => {
                        // The cultist get more and more annoyed and finally kill the player
                        gameState.flags.CultistAnnoyance++;
                        switch (gameState.flags.CultistAnnoyance) {
                            case 1:
                                gameState.message = "The cultist looks into the sky, not paying you any attention, however you can't move past him.";
                                break;
                            case 2:
                                gameState.message = "The cultist looks at you for a moment and then goes back to looking into the sky.";
                                break;
                            case 3:
                                gameState.message = "Cultist looks at you again and say 'Mmmm, who are you?', but goes back to looking into the sky without wating for the anwser";
                                break;
                            default:
                                gameState.message = "'Stop disturbing me.' he says and after a second you start feeling a pain in the chest, when you look at it you realized you have been stabbed.";
                                // Kick the player out of the close-up view after a short delay.
                                setTimeout(() => {
                                    // Check if we are still in the closeup scene before changing it.
                                    if (gameState.currentScene === 'City') {
                                        changeScene("Bad_end");		                        
 		                        const existingHotspots = gameArea.querySelectorAll('.hotspot'); 
 		                        existingHotspots.forEach(hs => hs.remove());
  		                        restartButton.style.display = 'inline-block';
                                    }
                                }, 2000); // 2-second delay
                                break;
                        }                }
            },
            "talk_to_cultist_leader": {
                handler: () => {
                        // The cultist get more and more annoyed and finally kill the player
                        gameState.flags.CultistLeaderAnnoyance++;
                        switch (gameState.flags.CultistLeaderAnnoyance) {
                            case 1:
                                gameState.message = "'Huh, who are you' says the cultist at the horse, however he does nothing apart from staring at you.";
                                break;
                            case 2:
                                gameState.message = "'Are you one of us? Why are dressed so weirdly', he starts to chant something.";
                                break;
                            default:
                                gameState.message = "'Doesn't matter you are one us now.' he says and after a second you start feeling your consciousness is leaving you";
                                // Kick the player out of the close-up view after a short delay.
                                setTimeout(() => {
                                    // Check if we are still in the closeup scene before changing it.
                                    if (gameState.currentScene === 'City') {
                                        changeScene("Bad_end2");
 		                        const existingHotspots = gameArea.querySelectorAll('.hotspot'); 
 		                        existingHotspots.forEach(hs => hs.remove());
  		                        restartButton.style.display = 'inline-block';
                                    }
                                }, 2000); // 2-second delay
                                break;
                        }                }
            }

        };

        // --- Core Game Logic ---
        function initializeGame() {
            gameState = {
                currentScene: "Gate",
                inventory: [],
                flags: {
                    hasExitKey: false,
                    exitDoorUnlocked: false,
                    trapdoor_unlocked: false,
                    stoneCollected: false,
                    chestOpened: false,
                    keyObtained: false,
		    rakeObtained: false,
		    CultistAnnoyance: 0, // ADDED: To track mood
		    CultistLeaderAnnoyance: 0, // ADDED: To track mood
                },
            };
            changeScene(gameState.currentScene, true);
            renderInventory();
            restartButton.style.display = 'none';
        }

        function changeScene(sceneId, isInitialLoad = false) {
            const scene = gameScenes[sceneId];
            if (!scene) {
                console.error("Scene not found:", sceneId);
                messageArea.textContent = "Error: Tried to load an invalid scene.";
                return;
            }

            gameState.currentScene = sceneId; 
            
            if (!isInitialLoad && gameImage.src !== scene.imageUrl) {
                gameImage.style.opacity = '0';
                setTimeout(() => {
                    gameImage.src = scene.imageUrl;
                    gameImage.alt = scene.message; 
                    gameImage.onload = () => gameImage.style.opacity = '1';
                    gameImage.onerror = () => { 
                        console.error("Failed to load scene background:", scene.imageUrl);
                        gameImage.alt = "Error loading scene background.";
                        gameImage.style.opacity = '1'; 
                    }
                }, 300); 
            } else {
                 gameImage.src = scene.imageUrl;
                 gameImage.alt = scene.message;
                 gameImage.style.opacity = '1';
                 gameImage.onerror = () => { 
                        console.error("Failed to load scene background:", scene.imageUrl);
                        gameImage.alt = "Error loading scene background.";
                    }
            }

            updateHotspotsForCurrentScene(); 
            
            if(isInitialLoad || gameState.message !== scene.message) {
                 gameState.message = scene.message;
            }
            renderMessage();
        }
        
        function updateHotspotsForCurrentScene() {
            const scene = gameScenes[gameState.currentScene];
            if (!scene) {
                console.error("updateHotspots: Current scene not found in gameScenes for ID:", gameState.currentScene);
                return;
            }

            const existingHotspots = gameArea.querySelectorAll('.hotspot');
            existingHotspots.forEach(hs => hs.remove()); 

            scene.hotspots.forEach(hsData => {
                 if (shouldDisplayHotspot(hsData.objectId, hsData)) { 
                    
                    let hotspotEl;
                    // *** MODIFIED LOGIC HERE ***
                    // If an imageUrl is provided, create an <img> element.
                    if (hsData.imageUrl) {
                        hotspotEl = document.createElement('img');
                        hotspotEl.src = hsData.imageUrl;
                        hotspotEl.onerror = () => { 
                            console.error("Failed to load hotspot image:", hsData.imageUrl);
                            hotspotEl.alt = `Error: ${hsData.id} image not found`;
                        };
                    } else {
                        // If no imageUrl, create a transparent <div> element.
                        hotspotEl = document.createElement('div');
                    }
                    
                    hotspotEl.classList.add('hotspot');
                    hotspotEl.alt = hsData.id || `hotspot-${hsData.objectId}`; 
                    hotspotEl.dataset.objectId = hsData.objectId; 
                    
                    for (const [key, value] of Object.entries(hsData.style)) {
                        hotspotEl.style[key] = value;
                    }
                    
                    hotspotEl.addEventListener('click', () => {
                        const sceneAtInteractionTime = gameScenes[gameState.currentScene];
                        const objectLogic = interactiveObjects[hsData.objectId];
                        if (objectLogic && typeof objectLogic.handler === 'function') {
                            objectLogic.handler();
                            renderMessage(); 
                            renderInventory();
                            
                            if (sceneAtInteractionTime === gameScenes[gameState.currentScene]) {
                                updateHotspotsForCurrentScene();
                            }
                        } else {
                            console.warn("No handler for objectId:", hsData.objectId);
                        }
                    });
                    gameArea.appendChild(hotspotEl);
                }
            });
        }

        function shouldDisplayHotspot(objectId, hsData) { 
            if (objectId === "pickup_red_flower" && gameState.flags.redFlowerTaken) return false;
            if (objectId === "pickup_red_flower" && gameState.flags.redFlowerTaken) return false;
            if (objectId === "inspect_rake" && gameState.flags.rakeObtained) return false;
            if (objectId === "pick_upchest_chest_key" && gameState.flags.keyObtained) return false;
            return true;
        }

        function renderMessage() { 
            messageArea.textContent = gameState.message;
            if (gameState.flags.exitDoorUnlocked || gameState.message.includes("Congratulations")) {
                 restartButton.style.display = 'inline-block';
            }
        }
        function renderInventory() { 
            inventoryList.innerHTML = '';
            if (gameState.inventory.length === 0) {
                inventoryList.appendChild(document.createElement('li')).textContent = "(Empty)";
            } else {
                gameState.inventory.forEach(item => {
                    inventoryList.appendChild(document.createElement('li')).textContent = item;
                });
            }
        }
        function addItemToInventory(item) { 
            if (!gameState.inventory.includes(item)) gameState.inventory.push(item);
        }
        function removeItemFromInventory(item) { 
            gameState.inventory = gameState.inventory.filter(i => i !== item);
        }
        function checkInventory(item) { 
            return gameState.inventory.includes(item);
        }

        // Event Listeners
        restartButton.addEventListener('click', initializeGame);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const initialSceneBg = new Image();
            initialSceneBg.onload = () => {
                 if (gameImage.complete || gameImage.naturalWidth > 0) { 
                    initializeGame();
                } else {
                    gameImage.onload = initializeGame; 
                    gameImage.onerror = () => {
                        messageArea.textContent = "Error: Could not load the initial game scene background. Please check image URLs.";
                    }
                }
            };
            initialSceneBg.onerror = () => {
                 messageArea.textContent = "Error: Preloading initial scene background failed. Check console.";
                 initializeGame(); 
            };
            if (gameScenes.Gate && gameScenes.Gate.imageUrl) {
                initialSceneBg.src = gameScenes.Gate.imageUrl;
            } else {
                messageArea.textContent = "Error: Initial scene configuration is missing. Cannot start game.";
                console.error("Initial scene 'Gate' or its imageUrl is not defined in gameScenes.");
            }
        });
    </script>
</body>
</html>
